<html>
    <head>
        <meta charset="utf8">
        <link rel="stylesheet" href="index.css">
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="/modules/"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1/new.min.css">
        <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    </head>
 
    <body style="max-width: none;">

        <section id="main">
            <h3 class="title" id="show-datasets">Datasets</h3>
            <div class="table-wrapper" id="show-datasets-table"></div>   
            <h3 class="title" id="register-datasets">Register Dataset</h3>
            <form method="post" action="/do/datasets/register">

                <input id="user_id" name="user_id" type="number" hidden/>

                <label for="provider">Provider</label><br>
                <input id="provider" name="provider" type="text"/><br>
                <br>

                <label for="name">Name of dataset</label><br>
                <input id="name" name="name" type="text"/><br>
                <br>

                <label for="institution">Institution of origin</label><br>
                <input id="institution" name="institution" type="text"/><br>
                <br>

                <label for="principal_investigator">Principal investigator</label><br>
                <input id="principal_investigator" name="principal_investigator" type="text"/><br>
                <br>


                <label for="source">Source</label><br>
                <!-- <input id="source" name="source" type="text"/><br> -->
                <div id="source"></div>
                <br>
                
                <label for="datatype">Evidence type</label><br>
                <!-- <input id="datatype" name="datatype" type="text"/><br> -->
                <div id="datatype"></div>
                <br>

                <!-- The collection state is autogenerated - I suppose -->
                <!-- <label for="state">Collection status</label><br>
                <input id="state" name="state" type="text"/><br>
                <br> -->

                <label for="embargo_date">Availability</label><br>
                <input type="checkbox"></input>
                    <!-- Choice as to where to set an embargo -->
                <input id="embargo_date" name="embargo_date" type="date"/><br>
                <br>

                <input id="submit" type="submit" name="action" value="Register"/>

            </form>
        </section>
    </body>
    <script>

        const url =  new URL(window.location.href);
        const user_id = url.searchParams.get("user");

        function tableify(arrayOfStructs, unique_element) {
            let fields = new Set();
            for (index in arrayOfStructs) {
                Object.keys(arrayOfStructs[index]).forEach(el => fields.add(el));
            }

            const table = document.createElement('table');
            const tableBody = document.createElement('tbody');

            table.appendChild(tableBody);

            const header = document.createElement('tr');
            fields.forEach(field => {
                const col = document.createElement('td');
                col.appendChild(document.createTextNode(field));
                header.appendChild(col);
            })
            tableBody.appendChild(header);

            for (index in arrayOfStructs) {
                const row = document.createElement('tr');
                Object.entries(arrayOfStructs[index]).forEach(entry => {
                    const col = document.createElement('td');
                    col.appendChild(document.createTextNode(entry[1]));
                    row.appendChild(col);
                })
                tableBody.appendChild(row);
            }

            document.querySelector(unique_element).appendChild(table)
        }

        function selectify(arrayOfValues, target, name, unique_element) {
            const select = document.createElement('select');
            select.name = name;
            arrayOfValues.forEach(optionValue => {
                console.log(optionValue)
                const option = document.createElement('option');
                option.value = optionValue.id;
                option.appendChild(document.createTextNode(optionValue[target]));
                select.appendChild(option);
            });
            document.querySelector(unique_element).appendChild(select);
        }

        function displayDatasets(datasets) {
            tableify(datasets, '#show-datasets-table')
        };
        function displayUsers(username) {
            document.getElementById('provider').value = username;
        }
        
        if (user_id) {

            console.log('userid exists, it is', user_id)
            document.getElementById('user_id').value = user_id;

            Date.prototype.toDateInputValue = (function() {
                var local = new Date(this);
                local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
                return local.toJSON().slice(0,10);
            });
            document.getElementById('embargo_date').value = new Date().toDateInputValue();

            const json = fetch(`/datasets/${user_id}`)
                .then(b => b.json())
                .then(displayDatasets)
                .catch(console.warn);

            // TODO: draw out from session?!? Is this insecure?
            const username = fetch(`/users/${user_id}/username`)
                .then(b => b.json())
                .then(displayUsers)
                .catch(console.warn);

           const possible_sources = fetch(`/do/query/datasets/sources`)
                .then(b => b.json())
                .then(sources => selectify(
                        sources,
                        'source',
                        'source', 
                        '#source'
                    )
                )
                .catch(console.warn);    
            
           const possible_types = fetch(`/do/query/datasets/datatypes`)
                .then(b => b.json())
                .then(types => selectify(
                        types,
                        'type', 
                        'datatype', 
                        '#datatype'
                    )
                )
                .catch(console.warn);    
            
        } else {
            console.warn('No user_id given on the datasets page!')
        }

    </script>
</html>